<h1
id="oauth2-flow-testing-a-comprehensive-analysis-of-response-types-and-modes">OAuth2
Flow Testing: A Comprehensive Analysis of Response Types and Modes</h1>
<p>When implementing OAuth2 authentication, developers face numerous
configuration choices that significantly impact both security and user
experience. While the OAuth2 specification provides guidance,
understanding how different combinations of response types and response
modes behave in practice requires empirical testing.</p>
<p>This post presents a systematic analysis of OAuth2 flows using
Google‚Äôs OAuth2 implementation, revealing key insights about token
delivery patterns, security implications, and practical recommendations
for production deployments.</p>
<h2 id="the-challenge-too-many-options-too-little-clarity">The
Challenge: Too Many Options, Too Little Clarity</h2>
<p>OAuth2 offers multiple response types (<code>code</code>,
<code>token</code>, <code>id_token</code>, and combinations) and
response modes (<code>query</code>, <code>fragment</code>,
<code>form_post</code>). This creates a matrix of possibilities:</p>
<ul>
<li><strong>Response Types</strong>: 7 different combinations</li>
<li><strong>Response Modes</strong>: 3 different delivery methods<br />
</li>
<li><strong>Scopes</strong>: Various combinations affecting token
types</li>
</ul>
<p>The result? 42 different flow configurations to understand. Rather
than rely on documentation alone, I built an automated testing framework
to examine how these flows actually behave.</p>
<h2 id="methodology-automated-flow-testing">Methodology: Automated Flow
Testing</h2>
<p>I created a Python script that systematically tests all OAuth2 flow
combinations:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core testing parameters</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>RESPONSE_TYPES <span class="op">=</span> [<span class="st">&#39;code&#39;</span>, <span class="st">&#39;token&#39;</span>, <span class="st">&#39;id_token&#39;</span>, <span class="st">&#39;code token&#39;</span>, <span class="st">&#39;code id_token&#39;</span>, <span class="st">&#39;token id_token&#39;</span>, <span class="st">&#39;code token id_token&#39;</span>]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>RESPONSE_MODES <span class="op">=</span> [<span class="st">&#39;query&#39;</span>, <span class="st">&#39;fragment&#39;</span>, <span class="st">&#39;form_post&#39;</span>]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>SCOPES <span class="op">=</span> [<span class="st">&#39;profile email&#39;</span>, <span class="st">&#39;openid profile email&#39;</span>]</span></code></pre></div>
<p>The testing framework:</p>
<ol type="1">
<li><strong>Generates authorization URLs</strong> for each
combination</li>
<li><strong>Opens browser windows</strong> for user authentication</li>
<li><strong>Captures responses</strong> across query parameters, form
data, and URL fragments</li>
<li><strong>Performs token exchange</strong> when authorization codes
are present</li>
<li><strong>Logs comprehensive results</strong> for analysis</li>
</ol>
<p>This approach provided empirical data on how Google‚Äôs OAuth2
implementation handles each flow configuration.</p>
<h2 id="key-findings-response-behavior-patterns">Key Findings: Response
Behavior Patterns</h2>
<p>See the results in <a
href="https://gist.github.com/ktaka-ccmp/915a3680f04f1704742f13e898ca668d?permalink_comment_id=5665842#gistcomment-5665842">Gist
page</a>.</p>
<h3 id="pattern-1-location-predictability">Pattern 1: Location
Predictability</h3>
<p>The testing revealed consistent patterns in where tokens are
delivered:</p>
<p><strong>Query/Fragment Modes:</strong> - Single <code>code</code>
responses ‚Üí Query parameters - Any token-containing responses ‚Üí URL
fragments - Multiple tokens ‚Üí Always delivered together</p>
<p><strong>Form Post Mode:</strong> - All responses ‚Üí Form parameters
(consistent delivery)</p>
<h3 id="pattern-2-token-grouping">Pattern 2: Token Grouping</h3>
<p>When multiple tokens are requested
(<code>response_type=code token id_token</code>), they are always
delivered together in the same location. You never see mixed delivery
like code in query parameters while tokens appear in fragments.</p>
<h3 id="pattern-3-scope-normalization">Pattern 3: Scope
Normalization</h3>
<p>Regardless of requested scope, Google consistently: - Adds
<code>openid</code> scope to all responses - Expands scopes to include
full URL versions - Maintains identical behavior for
<code>profile email</code> vs <code>openid profile email</code></p>
<h2 id="security-analysis-most-and-least-recommended-flows">Security
Analysis: Most and Least Recommended Flows</h2>
<h3 id="most-recommended-authorization-code-with-form-post">üèÜ Most
Recommended: Authorization Code with Form Post</h3>
<p><strong>Configuration</strong>: <code>response_type=code</code>,
<code>response_mode=form_post</code></p>
<p><strong>Why it‚Äôs secure:</strong> - No tokens in URLs or browser
history - Credentials don‚Äôt appear in server logs - Backend token
exchange enables client authentication - Authorization code is
short-lived and single-use</p>
<p><strong>Implementation benefits:</strong> - Simple to implement and
debug - Reliable across all browsers - No client-side token handling
required</p>
<h3 id="least-recommended-implicit-flows">‚ö†Ô∏è Least Recommended: Implicit
Flows</h3>
<p><strong>Configuration</strong>: <code>response_type=token</code> or
<code>response_type=id_token</code></p>
<p><strong>Security concerns:</strong> - Tokens exposed in URL fragments
- No client authentication possible - Higher risk of token leakage -
Tokens may be logged in browser history</p>
<p><strong>Functional limitations:</strong> - No refresh tokens
available - Shorter token lifetimes required - Limited error handling
capabilities</p>
<h2 id="practical-recommendations">Practical Recommendations</h2>
<h3 id="for-web-applications">For Web Applications</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Recommended: Authorization Code with Form Post</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authUrl <span class="op">=</span> <span class="vs">`https://accounts.google.com/o/oauth2/v2/auth?`</span> <span class="op">+</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`response_type=code&amp;`</span> <span class="op">+</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`response_mode=form_post&amp;`</span> <span class="op">+</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`client_id=</span><span class="sc">${</span>clientId<span class="sc">}</span><span class="vs">&amp;`</span> <span class="op">+</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`redirect_uri=</span><span class="sc">${</span>redirectUri<span class="sc">}</span><span class="vs">&amp;`</span> <span class="op">+</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`scope=openid profile email&amp;`</span> <span class="op">+</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`state=</span><span class="sc">${</span>state<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span></code></pre></div>
<h3 id="for-single-page-applications-spas">For Single Page Applications
(SPAs)</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Recommended: Authorization Code with PKCE</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authUrl <span class="op">=</span> <span class="vs">`https://accounts.google.com/o/oauth2/v2/auth?`</span> <span class="op">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`response_type=code&amp;`</span> <span class="op">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`response_mode=fragment&amp;`</span> <span class="op">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`client_id=</span><span class="sc">${</span>clientId<span class="sc">}</span><span class="vs">&amp;`</span> <span class="op">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`redirect_uri=</span><span class="sc">${</span>redirectUri<span class="sc">}</span><span class="vs">&amp;`</span> <span class="op">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`scope=openid profile email&amp;`</span> <span class="op">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`code_challenge=</span><span class="sc">${</span>codeChallenge<span class="sc">}</span><span class="vs">&amp;`</span> <span class="op">+</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`code_challenge_method=S256&amp;`</span> <span class="op">+</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`state=</span><span class="sc">${</span>state<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span></code></pre></div>
<p><strong>Note:</strong> Google‚Äôs current OAuth2 implementation
requires <code>client_secret</code> during token exchange even with
PKCE, which violates RFC 7636 standards. For authentication-only SPAs,
consider using <code>response_type=id_token</code> to avoid embedding
client secrets in your application code.</p>
<h3 id="security-enhancements">Security Enhancements</h3>
<p>Regardless of chosen flow, implement these security measures:</p>
<ol type="1">
<li><strong>Always use PKCE</strong> for code-based flows</li>
<li><strong>Implement state parameter</strong> for CSRF protection</li>
<li><strong>Use nonce parameter</strong> for replay protection</li>
<li><strong>Validate redirect URIs</strong> strictly</li>
<li><strong>Keep authorization codes short-lived</strong> (&lt; 10
minutes)</li>
</ol>
<h2 id="response-mode-comparison">Response Mode Comparison</h2>
<table>
<thead>
<tr class="header">
<th>Response Mode</th>
<th>Security</th>
<th>Reliability</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>form_post</code></td>
<td>‚úÖ Highest</td>
<td>‚úÖ Excellent</td>
<td>Web applications</td>
</tr>
<tr class="even">
<td><code>fragment</code></td>
<td>‚ö†Ô∏è Medium</td>
<td>‚úÖ Good</td>
<td>SPAs, mobile apps</td>
</tr>
<tr class="odd">
<td><code>query</code></td>
<td>‚ùå Lowest</td>
<td>‚úÖ Good</td>
<td>Legacy systems only</td>
</tr>
</tbody>
</table>
<h2 id="testing-your-own-implementation">Testing Your Own
Implementation</h2>
<p>The testing framework can be adapted for other OAuth2 providers:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration for different providers</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>PROVIDERS <span class="op">=</span> {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;google&#39;</span>: {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;auth_endpoint&#39;</span>: <span class="st">&#39;https://accounts.google.com/o/oauth2/v2/auth&#39;</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;token_endpoint&#39;</span>: <span class="st">&#39;https://oauth2.googleapis.com/token&#39;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;microsoft&#39;</span>: {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;auth_endpoint&#39;</span>: <span class="st">&#39;https://login.microsoftonline.com/common/oauth2/v2.0/authorize&#39;</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;token_endpoint&#39;</span>: <span class="st">&#39;https://login.microsoftonline.com/common/oauth2/v2.0/token&#39;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>This systematic analysis reveals that OAuth2 flow selection
significantly impacts both security and implementation complexity. Key
takeaways:</p>
<ol type="1">
<li><strong>Form Post mode</strong> provides the best security profile
for web applications</li>
<li><strong>Authorization code flows</strong> remain the gold standard
for secure authentication</li>
<li><strong>Implicit flows</strong> should be avoided in favor of
code-based alternatives</li>
<li><strong>Consistent testing</strong> is essential for understanding
provider-specific behavior</li>
</ol>
<p>The OAuth2 landscape continues evolving, with new security
enhancements like PKCE and PAR (Pushed Authorization Requests) becoming
standard. However, the fundamental principles revealed through this
testing remain relevant: prioritize security, minimize token exposure,
and thoroughly test your chosen configuration.</p>
<p>For production deployments, always combine empirical testing with
security best practices to ensure robust authentication flows that
protect both your application and your users.</p>
<hr />
<p><em>The complete testing framework and detailed results are available
in the <a
href="https://gist.github.com/ktaka-ccmp/915a3680f04f1704742f13e898ca668d?permalink_comment_id=5665842#gistcomment-5665842">Gist
page</a>. Feel free to adapt the testing methodology for your own OAuth2
implementations.</em></p>
